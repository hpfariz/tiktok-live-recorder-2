<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Live Recorder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 5px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: #333;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-monitoring { background: #e3f2fd; color: #1976d2; }
        .status-recording { background: #ffebee; color: #d32f2f; }
        .status-error { background: #ffebee; color: #d32f2f; }
        .status-uploading { background: #fff3e0; color: #f57c00; }
        .status-completed { background: #e8f5e8; color: #2e7d32; }
        .status-failed { background: #ffebee; color: #d32f2f; }

        .grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .user-item, .file-item, .upload-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .user-item.recording { border-left-color: #ff6b6b; background: #fff5f5; }
        .file-item.recording { border-left-color: #ff6b6b; background: #fff5f5; }
        .upload-item.uploading { border-left-color: #ffd43b; background: #fffbf0; }
        .upload-item.completed { border-left-color: #51cf66; background: #f3fff3; }
        .upload-item.failed { border-left-color: #ff6b6b; background: #fff5f5; }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .item-details {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .item-actions {
            margin-top: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-style: italic;
            background: white;
            border-radius: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .message.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left-color: #2e7d32;
        }

        .message.error {
            background: #ffebee;
            color: #d32f2f;
            border-left-color: #d32f2f;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .form-row .form-group {
            flex: 1;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .config-warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üé• TikTok Live Recorder</h1>
            <p>Record TikTok live streams with automatic monitoring and Google Drive upload</p>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('files')">üìÅ Files</button>
            <button class="nav-tab" onclick="showTab('uploads')">‚òÅÔ∏è Uploads</button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="stat-monitored">0</div>
                    <div class="stat-label">Monitored Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-recording">0</div>
                    <div class="stat-label">Currently Recording</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-files">0</div>
                    <div class="stat-label">Total Files</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-uploading">0</div>
                    <div class="stat-label">Uploading</div>
                </div>
            </div>

            <div class="card">
                <h2>Add User to Monitor</h2>
                <form onsubmit="addUser(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="username">TikTok Username</label>
                            <input type="text" id="username" placeholder="Enter username (without @)" required>
                        </div>
                        <div class="form-group">
                            <label for="interval">Check Interval (minutes)</label>
                            <input type="number" id="interval" value="5" min="1" max="60" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span id="add-loading" class="loading" style="display: none;"></span>
                            Add User
                        </button>
                    </div>
                </form>
                <div id="add-message"></div>
            </div>

            <div class="card">
                <h2>Monitored Users</h2>
                <div id="monitored-users" class="grid">
                    <div class="empty-state">No users being monitored. Add a user above to get started.</div>
                </div>
            </div>
        </div>

        <!-- Files Tab -->
        <div id="files" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Recorded Files</h2>
                    <div>
                        <button onclick="forceRefreshFileStatus()" class="btn btn-warning btn-small">üîß Fix Stuck Status</button>
                        <button onclick="refreshFiles()" class="btn btn-primary btn-small">üîÑ Refresh</button>
                    </div>
                </div>
                <div id="files-list" class="grid">
                    <div class="empty-state">Loading files...</div>
                </div>
            </div>
        </div>

        <!-- Uploads Tab -->
        <div id="uploads" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Upload Management</h2>
                    <div>
                        <button onclick="uploadAll()" class="btn btn-success btn-small">‚¨ÜÔ∏è Upload All</button>
                        <button onclick="testRcloneConfig()" class="btn btn-warning btn-small">üîß Test Config</button>
                        <button onclick="refreshUploads()" class="btn btn-primary btn-small">üîÑ Refresh</button>
                    </div>
                </div>
                <div id="upload-message"></div>
                
                <h3>Upload Queue</h3>
                <div id="upload-queue" class="grid" style="margin-bottom: 30px;">
                    <div class="empty-state">No uploads in progress</div>
                </div>

                <h3>Upload History</h3>
                <div id="upload-history" class="grid">
                    <div class="empty-state">No upload history</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'dashboard';
        const API_BASE = window.location.origin;

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;

            // Load data for the tab
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'files') {
                loadFiles();
            } else if (tabName === 'uploads') {
                loadUploads();
            }
        }

        // Debug functions
        async function debugFileStatus(username) {
            try {
                const response = await fetch(`${API_BASE}/api/recorder/debug/file-status/${username}`);
                const data = await response.json();
                
                let message = `Debug info for @${username}:\n\n`;
                message += `Total files: ${data.totalFiles}\n`;
                message += `Has auto-upload scheduled: ${data.hasAutoUploadScheduled}\n`;
                message += `Active recording: ${data.activeRecording ? JSON.stringify(data.activeRecording) : 'None'}\n\n`;
                
                message += `Files:\n`;
                data.files.forEach(file => {
                    message += `- ${file.filename} (${file.sizeFormatted})\n`;
                    message += `  Type: ${file.isFlv ? 'FLV' : file.isMp4 ? 'MP4' : 'Other'}\n`;
                    message += `  Modified: ${new Date(file.modified).toLocaleString()}\n\n`;
                });
                
                alert(message);
            } catch (error) {
                alert('Failed to get debug info: ' + error.message);
            }
        }

        async function triggerAutoUpload(username) {
            if (!confirm(`Manually trigger auto-upload for @${username}?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/recorder/debug/trigger-auto-upload/${username}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ${data.message}`);
                    loadDashboard();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Failed to trigger auto-upload: ' + error.message);
            }
        }

        async function debugUploadFiles(username) {
            try {
                const response = await fetch(`${API_BASE}/api/uploads/debug/files/${username}`);
                const data = await response.json();
                
                let message = `Upload debug for @${username}:\n\n`;
                message += `Total files: ${data.totalFiles}\n`;
                message += `In upload queue: ${data.uploadQueue.length}\n`;
                message += `In upload history: ${data.uploadHistory.length}\n\n`;
                
                message += `Files eligible for upload:\n`;
                data.files.forEach(file => {
                    message += `- ${file.filename} (${file.sizeFormatted})\n`;
                    message += `  MP4: ${file.isMp4}, FLV: ${file.isFlv}\n`;
                    message += `  In queue: ${file.inUploadQueue}, In history: ${file.inUploadHistory}\n\n`;
                });
                
                alert(message);
            } catch (error) {
                alert('Failed to get upload debug info: ' + error.message);
            }
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                // Test API connectivity first
                const healthResponse = await fetch(`${API_BASE}/health`);
                if (!healthResponse.ok) {
                    throw new Error('API server not responding');
                }

                const [usersRes, filesRes, uploadsRes] = await Promise.all([
                    fetch(`${API_BASE}/api/recorder/monitored`),
                    fetch(`${API_BASE}/api/files`),
                    fetch(`${API_BASE}/api/uploads`)
                ]);

                // Check if users response is OK
                if (!usersRes.ok) {
                    throw new Error(`Users API returned ${usersRes.status}: ${usersRes.statusText}`);
                }

                // Check content type for users response
                const usersContentType = usersRes.headers.get('content-type');
                if (!usersContentType || !usersContentType.includes('application/json')) {
                    const responseText = await usersRes.text();
                    console.error('Non-JSON response from users API:', responseText.substring(0, 200));
                    throw new Error('Users API returned HTML instead of JSON - check server routing');
                }

                const users = await usersRes.json();
                const files = await filesRes.json();
                const uploads = await uploadsRes.json();

                // Update stats
                document.getElementById('stat-monitored').textContent = users.length;
                document.getElementById('stat-recording').textContent = users.filter(u => u.isRecording).length;
                document.getElementById('stat-files').textContent = files.length;
                document.getElementById('stat-uploading').textContent = uploads.queue.length;

                // Display monitored users
                displayMonitoredUsers(users);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                
                // Show error message to user
                const container = document.getElementById('monitored-users');
                
                let errorMessage = '';
                if (error.message.includes('HTML instead of JSON')) {
                    errorMessage = `
                        <div class="empty-state" style="color: #d32f2f;">
                            <h3>üîß Server Configuration Issue</h3>
                            <p>The API routes are not properly configured.</p>
                            <p>This usually happens when the server is starting up.</p>
                            <button onclick="loadDashboard()" class="btn btn-primary btn-small" style="margin-top: 15px;">
                                üîÑ Retry
                            </button>
                        </div>
                    `;
                } else {
                    errorMessage = `
                        <div class="empty-state" style="color: #d32f2f;">
                            <h3>‚ö†Ô∏è API Connection Error</h3>
                            <p>Cannot connect to the backend API.</p>
                            <p>Error: ${error.message}</p>
                            <button onclick="loadDashboard()" class="btn btn-primary btn-small" style="margin-top: 15px;">
                                üîÑ Retry
                            </button>
                        </div>
                    `;
                }
                
                container.innerHTML = errorMessage;
                
                // Reset stats to show error state
                document.getElementById('stat-monitored').textContent = '?';
                document.getElementById('stat-recording').textContent = '?';
                document.getElementById('stat-files').textContent = '?';
                document.getElementById('stat-uploading').textContent = '?';
            }
        }

        function displayMonitoredUsers(users) {
            const container = document.getElementById('monitored-users');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-state">No users being monitored. Add a user above to get started.</div>';
                return;
            }

            container.innerHTML = users.map(user => `
                <div class="user-item ${user.isRecording ? 'recording' : ''}">
                    <div class="item-header">
                        <div class="item-title">@${user.username}</div>
                        <span class="status-badge status-${user.isRecording ? 'recording' : 'monitoring'}">
                            ${user.isRecording ? 'Recording' : 'Monitoring'}
                        </span>
                    </div>
                    <div class="item-details">
                        <div><strong>Check Interval:</strong> ${user.interval} minutes</div>
                        <div><strong>Added:</strong> ${new Date(user.addedAt).toLocaleString()}</div>
                        ${user.hasAutoUploadScheduled ? 
                            '<div style="color: #f57c00;"><strong>üì§ Auto-upload:</strong> Scheduled in ~5 minutes after recording ends</div>' : 
                            ''
                        }
                    </div>
                    <div class="item-actions">
                        <button onclick="removeUser('${user.username}')" class="btn btn-danger btn-small">
                            Remove
                        </button>
                        <button onclick="viewLogs('${user.username}')" class="btn btn-primary btn-small">
                            View Logs
                        </button>
                        <button onclick="debugFileStatus('${user.username}')" class="btn btn-warning btn-small">
                            üîç Debug Files
                        </button>
                        <button onclick="triggerAutoUpload('${user.username}')" class="btn btn-success btn-small">
                            üöÄ Trigger Upload
                        </button>
                        ${user.hasAutoUploadScheduled ? `
                            <button onclick="cancelAutoUpload('${user.username}')" class="btn btn-warning btn-small">
                                Cancel Auto-Upload
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function cancelAutoUpload(username) {
            if (!confirm(`Cancel scheduled auto-upload for @${username}?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/recorder/cancel-auto-upload/${username}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }

                const data = await response.json();
                alert(`Auto-upload cancelled for @${username}`);
                loadDashboard();
            } catch (error) {
                alert('Failed to cancel auto-upload: ' + error.message);
            }
        }

        async function addUser(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const interval = parseInt(document.getElementById('interval').value);
            const loading = document.getElementById('add-loading');
            const messageDiv = document.getElementById('add-message');
            
            loading.style.display = 'inline-block';
            
            try {
                const response = await fetch(`${API_BASE}/api/recorder/monitor`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, interval })
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }

                const data = await response.json();
                showMessage(messageDiv, `Started monitoring @${data.username}`, 'success');
                document.getElementById('username').value = '';
                loadDashboard();
            } catch (error) {
                showMessage(messageDiv, 'Failed to add user: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        async function removeUser(username) {
            if (!confirm(`Stop monitoring @${username}?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/recorder/monitor/${username}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (response.ok) {
                    loadDashboard();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to remove user: ' + error.message);
            }
        }

        async function viewLogs(username) {
            try {
                const response = await fetch(`${API_BASE}/api/recorder/logs/${username}`);
                const data = await response.json();
                
                if (response.ok) {
                    const logs = data.logs.map(log => 
                        `[${new Date(log.timestamp).toLocaleTimeString()}] ${log.message}`
                    ).join('\n');
                    
                    alert(`Logs for @${username}:\n\n${logs || 'No logs available'}`);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to get logs: ' + error.message);
            }
        }

        // Files functions
        async function loadFiles() {
            try {
                const response = await fetch(`${API_BASE}/api/files`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const files = await response.json();
                displayFiles(files);
            } catch (error) {
                console.error('Error loading files:', error);
                document.getElementById('files-list').innerHTML = '<div class="empty-state">Error loading files</div>';
            }
        }

        function displayFiles(files) {
            const container = document.getElementById('files-list');
            
            if (files.length === 0) {
                container.innerHTML = '<div class="empty-state">No recorded files found</div>';
                return;
            }

            container.innerHTML = files.map(file => {
                // Determine the actual recording status
                let isRecording = file.isCurrentlyRecording;
                let statusText = 'Completed';
                let statusClass = 'completed';
                
                if (isRecording) {
                    statusText = 'Recording';
                    statusClass = 'recording';
                }
                
                // Actions based on file state
                const canDownload = !isRecording;
                const canUpload = !isRecording && file.filename.endsWith('.mp4');
                const canDelete = !isRecording;
                
                return `
                    <div class="file-item ${isRecording ? 'recording' : ''}">
                        <div class="item-header">
                            <div class="item-title">${file.filename}</div>
                            <span class="status-badge status-${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                        <div class="item-details">
                            <div><strong>User:</strong> @${file.username}</div>
                            <div><strong>Size:</strong> ${file.sizeFormatted}</div>
                            <div><strong>Created:</strong> ${new Date(file.createdAt).toLocaleString()}</div>
                            <div><strong>Modified:</strong> ${new Date(file.modifiedAt).toLocaleString()}</div>
                        </div>
                        <div class="item-actions">
                            ${canDownload ? `
                                <button onclick="downloadFile('${file.filename}')" class="btn btn-primary btn-small">
                                    üì• Download
                                </button>
                            ` : ''}
                            ${canUpload ? `
                                <button onclick="uploadFile('${file.filename}')" class="btn btn-success btn-small">
                                    ‚òÅÔ∏è Upload
                                </button>
                            ` : ''}
                            ${canDelete ? `
                                <button onclick="deleteFile('${file.filename}')" class="btn btn-danger btn-small">
                                    üóëÔ∏è Delete
                                </button>
                            ` : ''}
                            ${isRecording ? `
                                <span style="color: #ff6b6b; font-style: italic;">
                                    Currently recording...
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function forceRefreshFileStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/files/debug/clear-stuck`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }

                const data = await response.json();
                alert(`‚úÖ ${data.message}`);
                loadFiles();
            } catch (error) {
                alert('Failed to refresh status: ' + error.message);
            }
        }

        async function refreshFiles() {
            loadFiles();
        }

        function downloadFile(filename) {
            window.open(`${API_BASE}/api/files/download/${encodeURIComponent(filename)}`, '_blank');
        }

        async function uploadFile(filename) {
            try {
                const response = await fetch(`${API_BASE}/api/uploads/upload/${encodeURIComponent(filename)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }

                const data = await response.json();
                alert(`Upload started for ${filename}`);
                if (currentTab === 'uploads') {
                    loadUploads();
                }
            } catch (error) {
                alert('Failed to start upload: ' + error.message);
            }
        }

        async function deleteFile(filename) {
            if (!confirm(`Delete ${filename}?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/files/${encodeURIComponent(filename)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }

                const data = await response.json();
                loadFiles();
            } catch (error) {
                alert('Failed to delete file: ' + error.message);
            }
        }

        // Upload functions
        async function loadUploads() {
            try {
                const response = await fetch(`${API_BASE}/api/uploads`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                displayUploads(data.queue, data.history);
            } catch (error) {
                console.error('Error loading uploads:', error);
            }
        }

        function displayUploads(queue, history) {
            const queueContainer = document.getElementById('upload-queue');
            const historyContainer = document.getElementById('upload-history');
            
            // Display upload queue
            if (queue.length === 0) {
                queueContainer.innerHTML = '<div class="empty-state">No uploads in progress</div>';
            } else {
                queueContainer.innerHTML = queue.map(upload => `
                    <div class="upload-item uploading">
                        <div class="item-header">
                            <div class="item-title">${upload.filename}</div>
                            <span class="status-badge status-uploading">
                                ${upload.isAutoUpload ? 'ü§ñ Auto-Uploading' : 'Uploading'}
                            </span>
                        </div>
                        <div class="item-details">
                            <div><strong>User:</strong> @${upload.username}</div>
                            <div><strong>Started:</strong> ${new Date(upload.startTime).toLocaleString()}</div>
                            <div><strong>Destination:</strong> ${upload.remotePath}</div>
                            ${upload.isAutoUpload ? 
                                '<div style="color: #2e7d32;"><strong>Type:</strong> Automatic upload (triggered 5 min after recording)</div>' : 
                                '<div style="color: #1976d2;"><strong>Type:</strong> Manual upload</div>'
                            }
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${upload.progress || 0}%"></div>
                        </div>
                        <div style="text-align: center; margin-top: 5px; font-size: 0.9rem;">
                            ${upload.progress || 0}% complete
                        </div>
                        <div class="item-actions">
                            <button onclick="cancelUpload('${upload.filename}')" class="btn btn-danger btn-small">
                                Cancel Upload
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Display upload history
            if (history.length === 0) {
                historyContainer.innerHTML = '<div class="empty-state">No upload history</div>';
            } else {
                historyContainer.innerHTML = history.map(upload => `
                    <div class="upload-item ${upload.status}">
                        <div class="item-header">
                            <div class="item-title">${upload.filename}</div>
                            <span class="status-badge status-${upload.status}">
                                ${upload.status.charAt(0).toUpperCase() + upload.status.slice(1)}
                                ${upload.isAutoUpload ? ' (Auto)' : ''}
                            </span>
                        </div>
                        <div class="item-details">
                            <div><strong>User:</strong> @${upload.username}</div>
                            <div><strong>Started:</strong> ${new Date(upload.startTime).toLocaleString()}</div>
                            <div><strong>Completed:</strong> ${new Date(upload.completedAt).toLocaleString()}</div>
                            <div><strong>Destination:</strong> ${upload.remotePath}</div>
                            ${upload.isAutoUpload ? 
                                '<div style="color: #2e7d32;"><strong>Type:</strong> Automatic upload</div>' : 
                                '<div style="color: #1976d2;"><strong>Type:</strong> Manual upload</div>'
                            }
                            ${upload.error ? `<div style="color: #d32f2f;"><strong>Error:</strong> ${upload.error}</div>` : ''}
                        </div>
                    </div>
                `).join('');
            }
        }

        async function uploadAll() {
            if (!confirm('Upload all completed recordings to Google Drive?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/uploads/upload-all`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }

                const data = await response.json();
                showMessage(document.getElementById('upload-message'), data.message, 'success');
                loadUploads();
            } catch (error) {
                showMessage(document.getElementById('upload-message'), 'Failed to start bulk upload: ' + error.message, 'error');
            }
        }

        async function cancelUpload(filename) {
            if (!confirm(`Cancel upload for ${filename}?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/uploads/cancel/${encodeURIComponent(filename)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }

                const data = await response.json();
                loadUploads();
            } catch (error) {
                alert('Failed to cancel upload: ' + error.message);
            }
        }

        async function testRcloneConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/uploads/test-config`);
                
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(document.getElementById('upload-message'), '‚úÖ ' + data.message, 'success');
                } else {
                    showMessage(document.getElementById('upload-message'), '‚ùå ' + data.message + '\n' + data.error, 'error');
                }
            } catch (error) {
                showMessage(document.getElementById('upload-message'), 'Failed to test configuration: ' + error.message, 'error');
            }
        }

        async function refreshUploads() {
            loadUploads();
        }

        // Utility functions
        function showMessage(container, message, type) {
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            setInterval(() => {
                if (currentTab === 'dashboard') {
                    loadDashboard();
                } else if (currentTab === 'files') {
                    loadFiles();
                } else if (currentTab === 'uploads') {
                    loadUploads();
                }
            }, 5000); // Refresh every 5 seconds
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            startAutoRefresh();
        });
    </script>
</body>
</html>